kind: pipeline
type: kubernetes
name: infra-tools-test

steps:
- name: publish test image
  image: plugins/docker
  settings:
    username:
      from_secret: docker_username
    password:
      from_secret: docker_password
    repo: autkast/infrastructure-tools
    tags:
    - sha-${DRONE_COMMIT_SHA}

- name: test image
  image: autkast/infrastructure-tools:sha-${DRONE_COMMIT_SHA}
  commands:
  - kubectl version --client
  - helm version --client
  - aws --version

- name: push as tagged and latest
  image: docker:dind
  when:
    event:
      - tag
  environment:
    - DOCKER_USERNAME:
        from_Secret: docker_username
    - DOCKER_PASSWORD:
        from_secret: docker_password
  volumes:
  - name: dockersock
    path: /var/run
  commands:
  - sleep 10
  - docker ps -a
  - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
  - docker tag autkast/infrastructure-tools:sha-${DRONE_COMMIT_SHA} autkast/infrastructure-tools:${DRONE_TAG} && docker tag autkast/infrastructure-tools:sha-${DRONE_COMMIT_SHA} autkast/infrastructure-tools:latest
  - docker image push autkast/infrastructure-tools:${DRONE_TAG} && docker image push autkast/infrastructure-tools:latest

services:
- name: docker
  image: docker:dind
  privileged: true
  volumes:
  - name: dockersock
    path: /var/run

volumes:
- name: dockersock
  temp: {}
