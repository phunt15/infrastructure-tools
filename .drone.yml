kind: pipeline
type: kubernetes
name: infra-tools-test

steps:
- name: build, test, and push commit image tag
  image: docker:dind
  environment:
    PASSWORD:
      from_secret: docker_password
    USERNAME:
      from_secret: docker_username
  volumes:
  - name: dockersock
    path: /var/run
  commands:
  - echo $${USERNAME}
  # - sleep 10s
  # - docker login --username ${DOCKER_USERNAME} --password ${DOCKER_PASSWORD}
  # - docker build -t "autkast/infrastructure-tools:sha-${DRONE_COMMIT_SHA}" .
  # - docker run autkast/infrastructure-tools:sha-${DRONE_COMMIT_SHA} sh -c "kubectl version --client"
  # - docker run autkast/infrastructure-tools:sha-${DRONE_COMMIT_SHA} sh -c "helm version --client"
  # - docker run autkast/infrastructure-tools:sha-${DRONE_COMMIT_SHA} sh -c "aws --version"
  # - docker push autkast/infrastructure-tools:sha-${DRONE_COMMIT_SHA}

# - name: test image
#   image: autkast/infrastructure-tools:sha-${DRONE_COMMIT_SHA}
#   commands:
#   - kubectl version --client
#   - helm version --client
#   - aws --version

- name: publish as tagged and latest
  image: docker:dind
  when:
    event:
      - tag
  volumes:
  - name: dockersock
    path: /var/run
  commands:
  # - docker tag autkast/infrastructure-tools:sha-${DRONE_COMMIT_SHA} autkast/infrastructure-tools:${DRONE_TAG}
  - docker tag autkast/infrastructure-tools:sha-${DRONE_COMMIT_SHA} autkast/infrastructure-tools:latest
  # - docker image push autkast/infrastructure-tools:${DRONE_TAG}
  - docker image push autkast/infrastructure-tools:latest

services:
- name: docker
  image: docker:dind
  privileged: true
  volumes:
  - name: dockersock
    path: /var/run

volumes:
- name: dockersock
  temp: {}
